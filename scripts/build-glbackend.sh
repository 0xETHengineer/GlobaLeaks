#!/bin/bash
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
. ${DIR}/common_inc.sh

usage()
{
cat << EOF
usage: ./${SCRIPTNAME} options

OPTIONS:
   -h      Show this message
   -v      To build a tagged release
   -n      To build a non signed package

EOF
}

SIGN=1
while getopts “hv:n” OPTION
do
  case $OPTION in
    h)
      usage
      exit 1
      ;;
    v)
      TAG=$OPTARG
      ;;
    n)
      SIGN=0
      ;;
    ?)
      usage
      exit
      ;;
    esac
done

build_glbackend()
{
  cd ${BUILD_DIR}
  if [ -d ${GLBACKEND_TMP} ]; then
    echo "Directory ${GLBACKEND_TMP} already present and need to be removed"
    read -n1 -p "Do you want to delete ${GLBACKEND_TMP}? (y/n): "
    echo
    if [[ $REPLY != [yY] ]]; then
      echo "Cannot proceed"
      exit
    fi
    rm -rf ${GLBACKEND_TMP}
  fi
  BUILD_USES_EXISTENT_DIR=0
  if [ -d ${GLBACKEND_DIR} ]; then
    echo "Directory ${GLBACKEND_DIR} already present"
    echo "The build process needs a clean git clone of GLBackend"
    echo "If not deleted the build script will use the existent dir"
    read -n1 -p "Do you want to delete ${GLBACKEND_DIR}? (y/n): "
    echo
    if [[ $REPLY == [yY] ]]; then
      echo "Removing directory ${GLBACKEND_DIR}"
      rm -rf ${GLBACKEND_DIR}
    else
      BUILD_USES_EXISTENT_DIR=1
      cp ${GLBACKEND_DIR} ${GLBACKEND_TMP} -r
      cd ${GLBACKEND_TMP}
    fi
  fi

  if [ ${BUILD_USES_EXISTENT_DIR} -eq 0 ]; then
    echo "[+] Cloning GLBackend in ${GLBACKEND_DIR}"
    git clone $GLBACKEND_GIT_REPO ${GLBACKEND_DIR}
    cp ${GLBACKEND_DIR} ${GLBACKEND_TMP} -r
    cd ${GLBACKEND_TMP}

    if test $GLBACKEND_TAG; then
      git checkout $GLBACKEND_TAG
      GLBACKEND_REVISION=$GLBACKEND_TAG
    else
      GLBACKEND_REVISION=`git rev-parse HEAD | cut -c 1-8`
    fi
  fi

  unzip ${GLC_BUILD}/*.zip -d ${GLBACKEND_TMP}
  mv ${GLBACKEND_TMP}/glclient* ${GLBACKEND_TMP}/glclient

  echo "[+] Building GLBackend"
  POSTINST=${GLBACKEND_TMP}/debian/postinst
  echo "/etc/init.d/globaleaks start" >> $POSTINST
  echo "# generated by your friendly globaleaks build bot :)" >> $POSTINST
  python setup.py sdist
  echo "[+] Building .deb"

  cd dist
  py2dsc globaleaks-*.tar.gz
  cd deb_dist/globaleaks-*
  rm -rf debian/
  cp -rf ${GLBACKEND_TMP}/debian debian

  if [ $SIGN -eq 1 ]; then
    debuild
  else
    debuild -i -us -uc -b
  fi

  mv ${GLBACKEND_TMP}/dist ${GLB_BUILD}
}

build_glbackend

echo "[+] All done!"
echo ""
echo "GLBackend build is now present in ${GLB_BUILD}"

