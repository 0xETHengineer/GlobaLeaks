from twisted.internet.defer import inlineCallbacks

from globaleaks.tests import helpers

from globaleaks.handlers import submission
from globaleaks.jobs import delivery_sched
from globaleaks.jobs.mailflush_sched import MailflushSchedule
from globaleaks.jobs.notification_sched import NotificationSchedule
from globaleaks.settings import GLSetting
from globaleaks.plugins.notification import MailNotification
from cyclone.util import ObjectDict as OD

bigblob = {'notification_settings': {'username': u'sendaccount@lists.globaleaks.org', 'pgp_alert_mail_template': u'Dear %ReceiverName%,\n\nThis is an e-mail to inform you that your PGP key is expiring or already expired.\n\n%PGPKeyInfo%\n\nWithout a valid PGP key, the system will not be able to send you encrypted notifications.\n\nYou should extend its validity and update the key present on the GlobaLeaks nodes you are subscribed to or upload a new key.\n\nKind regards,\n%NodeSignature%\n', 'pgp_alert_mail_title': u'PGP Key Expiration Alert\n', 'source_name': u'Default GlobaLeaks sender', 'encrypted_message_mail_title': u'[Tip %TipNum%] New message on context %ContextName%\n', 'ping_mail_template': u'Dear %ReceiverName%,\n\nThere are %EventCount% good reasons to connect exactly where you know!\n', 'disable_admin_notification_emails': False, 'disable_receivers_notification_emails': False, 'plaintext_upcoming_mail_title': '', 'plaintext_comment_template': u'Dear %ReceiverName%,\n\nThis is an e-mail notification to notify you that %CommentSource% has commented on a previous submission.\n\nThis has happened on context %ContextName% at %EventTime%.\n\nYou can read it at: %TipTorURL%\n\nKind regards,\n%NodeSignature%\n', 'plaintext_comment_mail_title': u'[Tip %TipNum%] New comment\n', 'encrypted_tip_template': u'Dear %ReceiverName%,\n\nThis is an e-mail notification to notify you that a whistleblower has selected you as a valuable recipient for his/her submission.\n\nThey would like you to pay special attention to the information and material contained therein. Please keep in mind that whistleblowers often expose themselves to high personal risks for the public interest. Therefore the material that they provide with this tip-off should be considered of high importance.\n\nThe submission can be accessed:\nvia Tor at: %TipTorURL%\nvia Tor2web at: %TipT2WURL%\n\nSubmission date: %EventTime%\n\nPlease do not forward or share this e-mail: each tip-off allows a limited number of accesses and downloads before being destroyed forever and nobody (even the node administrator) can recover an expired or dead tip-off.\n\nKind regards,\n%NodeSignature%\n', 'source_email': u'sendaccount@lists.globaleaks.org', 'encrypted_tip_mail_title': u'[Tip %TipNum%] New submission on context %ContextName%\n', 'encrypted_file_template': u'Dear %ReceiverName%,\n\nThis is an e-mail notification to notify you that a whistleblower has updated a submission with new material.\n\nThis has happened on context %ContextName% at %EventTime%.\n\nYou can read it at: %TipTorURL%\n\nKind regards,\n%NodeSignature%\n', 'plaintext_tip_mail_title': u'[Tip %TipNum%] New submission\n', 'admin_anomaly_template': u'Dear Globaleaks Node Administrator,\nThe anomaly detection system of your GlobaLeaks node has identified some unexpected activity.\nThis could be the sign of an attack or just a spike in usage due to the increased visibility of your initiative.\n\nYou are receiving this email because you should look into this to determine if the cause is malicious or not.\n\nHere is the list of activities that have triggered the anomaly detection:\n\nAlarm level: %ActivityAlarmLevel%\n%ActivityDump%\n\nDisk space:\n\nAlarm level: %DiskAlarmLevel%\n%DiskDump%\n\nFor more info, login in your Administration panel and navigate to the Stats and Anomalies section.\n\nKind regards,\n%NodeSignature%\n', 'password': u'sendaccount99', 'port': 587, 'plaintext_file_template': u'Dear %ReceiverName%,\n\nThis is an e-mail notification to notify you that a whistleblower has updated a submission with new material.\n\nThis has happened on context %ContextName% at %EventTime%.\n\nYou can read it at: %TipTorURL%\n\nKind regards,\n%NodeSignature%\n', 'plaintext_message_template': u'Dear %ReceiverName%,\n\nThis is an e-mail notification to notify you about new message from the whisleblower.\n\nThis has happened on context %ContextName% at %EventTime%.\n\nYou can read it at: %TipTorURL%\n\nKind regards,\n%NodeSignature%\n', 'plaintext_file_mail_title': u'[Tip %TipNum%] New attachment\n', 'admin_pgp_alert_mail_title': u'PGP Key Expiration Alert\n', 'zip_description': u'The following represents a description of the file collection and its content.\n\nThe included files may contain information that could lead to the identification of the whistleblower and/or that is sensitive for the people and organisations involved.\n\nPlease never disclose these files until an appropriate analysis, fact checking, journalistic and technical redaction process. For more information about redaction of documents you should consult this page: https://github.com/globaleaks/GlobaLeaks/wiki/Redaction-process.\n\nFiles number: %FilesNumber%\nTotal uncompressed size: %TotalSize%\n\nFile details:\n\n%FileList%\n\nKind regards,\n%NodeSignature%\n', 'plaintext_upcoming_template': '', 'encrypted_upcoming_mail_title': '', 'plaintext_message_mail_title': u'[Tip %TipNum%] New message\n', 'ping_mail_title': u'There are %EventCount% good reasons to...\n', 'server': u'mail.headstrong.de', 'admin_pgp_alert_mail_template': u'Dear Globaleaks Node Administrator,\n\nThis is an e-mail to inform you that the PGP key of the following users is going to expire or is already expired:\n\n%PGPKeyInfoList%\n\nWithout a valid PGP key, the system will not be able to send them encrypted notifications.\n\nKind regards,\n%NodeSignature%\n', 'plaintext_tip_template': u'Dear %ReceiverName%,\n\nThis is an e-mail notification to notify you that a whistleblower has selected you as a valuable recipient for his/her submission.\n\nThey would like you to pay special attention to the information and material contained therein. Please keep in mind that whistleblowers often expose themselves to high personal risks for the public interest. Therefore the material that they provide with this tip-off should be considered of high importance.\n\nThe submission can be accessed:\nvia Tor at: %TipTorURL%\nvia Tor2web at: %TipT2WURL%\n\nSubmission date: %EventTime%\n\nPlease do not forward or share this e-mail: each tip-off allows a limited number of accesses and downloads before being destroyed forever and nobody (even the node administrator) can recover an expired or dead tip-off.\n\nKind regards,\n%NodeSignature%\n', 'encrypted_comment_mail_title': u'[Tip %TipNum%] New comment on context %ContextName%\n', 'encrypted_upcoming_template': '', 'encrypted_comment_template': u'Dear %ReceiverName%,\n\nThis is an e-mail notification to notify you that %CommentSource% has commented on a previous submission.\n\nThis has happened on context %ContextName% at %EventTime%.\n\nYou can read it at: %TipTorURL%\n\nKind regards,\n%NodeSignature%\n', 'security': u'TLS', 'encrypted_message_template': u'Dear %ReceiverName%,\n\nThis is an e-mail notification to notify you about new message from the whisleblower.\n\nThis has happened on context %ContextName% at %EventTime%.\n\nYou can read it at: %TipTorURL%\n\nKind regards,\n%NodeSignature%\n', 'encrypted_file_mail_title': u'[Tip %TipNum%] New attachment on context %ContextName%\n'}, 'steps_info': [{u'id': u'18e67a13-c3f5-459e-a546-5c3f53d432ba', u'label': u'Fill out your submission', u'children': [{u'fieldgroup_id': u'', u'description': u'', u'hint': u'Describe your submission with a few words', u'multi_entry': False, u'stats_enabled': False, u'required': False, u'children': [], u'value': u'', u'label': u'Short title', u'is_template': False, u'options': [], u'x': 0, u'y': 2, u'step_id': u'18e67a13-c3f5-459e-a546-5c3f53d432ba', u'preview': True, u'type': u'inputbox', u'id': u'058df7d1-c938-407b-af21-a496ebd6eb44'}, {u'fieldgroup_id': u'', u'description': u'', u'hint': u'Describe the details of the submission', u'multi_entry': False, u'stats_enabled': False, u'required': False, u'children': [], u'value': u'', u'label': u'Full description', u'is_template': False, u'options': [], u'x': 0, u'y': 3, u'step_id': u'18e67a13-c3f5-459e-a546-5c3f53d432ba', u'preview': False, u'type': u'textarea', u'id': u'40ec5609-33ac-46b3-b602-5d43276b157a'}, {u'fieldgroup_id': u'', u'description': u'', u'hint': u'Describe the attachments of the submission', u'multi_entry': False, u'stats_enabled': False, u'required': False, u'children': [], u'value': u'', u'label': u'Files description', u'is_template': False, u'options': [], u'x': 0, u'y': 4, u'step_id': u'18e67a13-c3f5-459e-a546-5c3f53d432ba', u'preview': False, u'type': u'textarea', u'id': u'6be1eb97-46f7-404e-910b-a1ce1108c295'}, {u'fieldgroup_id': u'', u'description': u'', u'hint': u'Attach files relevant to the submission', u'multi_entry': True, u'stats_enabled': False, u'required': False, u'children': [], u'value': u'', u'label': u'Files', u'is_template': False, u'options': [], u'x': 0, u'y': 5, u'step_id': u'18e67a13-c3f5-459e-a546-5c3f53d432ba', u'preview': False, u'type': u'fileupload', u'id': u'5c239590-c30a-46be-a2f0-a0c03d127078'}], u'description': u'', u'hint': u''}], 'receiver_info': {u'presentation_order': 0, u'gpg_key_status': u'disabled', u'file_notification': True, u'postpone_superpower': False, u'creation_date': u'2015-03-02T20:58:50.106669Z', u'gpg_key_info': None, u'id': u'6a48c127-f620-4ea9-a577-98254fb4f640', u'timezone': 0, u'gpg_key_remove': False, u'configuration': u'default', u'message_notification': True, u'state': u'enabled', u'last_update': u'1970-01-01T00:00:00Z', u'can_delete_submission': False, u'gpg_key_expiration': u'1970-01-01T00:00:00Z', u'username': u'06e04fff-463d-4715-8aa7-b0212ff5adea', u'description': u'', u'password_change_needed': True, u'gpg_key_armor': None, u'ping_notification': False, u'password': u'', u'gpg_key_fingerprint': None, u'comment_notification': True, u'mail_address': u'claudio.agosti@logioshermes.org', u'name': u'claudio.agosti@logioshermes.org', u'language': u'en', u'contexts': [u'3c3032f2-9b9c-4231-bbed-12e332188b07'], u'ping_mail_address': u'claudio.agosti@logioshermes.org', u'tip_notification': True}, 'subevent_info': None, 'node_info': {'languages_supported': [{'code': 'ar', 'name': 'Arabic'}, {'code': 'ca', 'name': 'Catalan'}, {'code': 'cs', 'name': 'Czech'}, {'code': 'de', 'name': 'German'}, {'code': 'el', 'name': 'Greek'}, {'code': 'en', 'name': 'English'}, {'code': 'es', 'name': 'Spanish'}, {'code': 'fi', 'name': 'Finnish'}, {'code': 'fr', 'name': 'French'}, {'code': 'he', 'name': 'Hebrew'}, {'code': 'hr_HR', 'name': 'Croatian (Croatia)'}, {'code': 'hu_HU', 'name': 'Hungarian (Hungary)'}, {'code': 'it', 'name': 'Italian'}, {'code': 'ja', 'name': 'Japanese'}, {'code': 'lv', 'name': 'Latvian'}, {'code': 'nb_NO', 'name': 'Norwegian Bokm\xc3\xa5l (Norway)'}, {'code': 'nl', 'name': 'Dutch'}, {'code': 'pl', 'name': 'Polish'}, {'code': 'pt_BR', 'name': 'Portuguese (Brazil)'}, {'code': 'pt_PT', 'name': 'Portuguese (Portugal)'}, {'code': 'ru', 'name': 'Russian'}, {'code': 'sk', 'name': 'Slovak'}, {'code': 'sr_RS', 'name': 'Serbian (Serbia)'}, {'code': 'sr_RS@latin', 'name': 'Serbian (Latin) (Serbia)'}, {'code': 'sv', 'name': 'Swedish'}, {'code': 'th', 'name': 'Thai'}, {'code': 'tr', 'name': 'Turkish'}, {'code': 'uk', 'name': 'Ukrainian'}, {'code': 'ur', 'name': 'Urdu'}, {'code': 'zh_CN', 'name': 'Chinese (China)'}], 'security_awareness_title': u'Warning! You are not Anonymous.', 'default_language': u'en', 'postpone_superpower': True, 'disable_security_awareness_questions': False, 'custom_privacy_badge_none': u'', 'can_delete_submission': True, 'presentation': u'This is the default welcome message', 'languages_enabled': [u'en'], 'header_title_homepage': u'sd', 'ahmia': False, 'header_title_submissionpage': u'Blow the whistle', 'disable_privacy_badge': True, 'stats_update_time': 2, 'default_timezone': 0, 'admin_timezone': 0, 'password': u'', 'whistleblowing_button': u'Blow the whistle', 'custom_homepage': False, 'landing_page': u'homepage', 'wizard_done': True, 'name': u'sd', 'tor2web_unauth': True, 'tor2web_submission': True, 'public_site': u'', 'enable_custom_privacy_badge': False, 'configured': True, 'allow_iframes_inclusion': False, 'creation_date': '2015-03-02T20:57:59.452117Z', 'whistleblowing_question': u'Are you a whistleblower?', 'maximum_textsize': 4096, 'maximum_namesize': 128, 'admin_language': u'en', 'tor2web_admin': True, 'exception_email': u'globaleaks-stackexception@lists.globaleaks.org', 'last_update': '2015-03-02T21:01:55.989992Z', 'version': u'2.60.63', 'disable_security_awareness_badge': True, 'email': u'claudio.agosti@logioshermes.org', 'description': u'w', 'tor2web_receiver': False, 'custom_privacy_badge_tor': u'', 'allow_unencrypted': True, 'footer': u'proudly powered by GlobaLeaks, copyright by Hermes Center for Transparency and Digital Human Rights', 'maximum_filesize': 3, 'header_title_receiptpage': u'Submission successfully completed!', 'security_awareness_text': u'With a HTTPS submission you are exposing yourself to the risks that someone else will know that you have submitted something, without knowing what you have submitted.\n\nInstead with an Anonymous Submission you are fully protected, it is not possible for a third party to know that you have submitted something nor what you have submitted.\n\nWe strongly advise you to go for an Anonymous Submission.\n\nTo make an Anonymous Submission, instead of using your usual Web Browser (Internet Explorer, Chrome, Firefox, Opera, etc.) you should use the Tor Browser Bundle. This is a special piece of software designed to enable Anonymous Web Browsing.', 'old_password': u'', 'hidden_service': u''}, 'trigger': u'UpcomingExpireTip', 'context_info': {u'show_receivers': False, u'receiver_introduction': u'', u'enable_private_messages': True, u'description': u'', u'receivers': [u'6a48c127-f620-4ea9-a577-98254fb4f640'], u'select_all_receivers': True, u'presentation_order': 0, u'maximum_selectable_receivers': 0, u'tip_timetolive': 3, u'creation_date': u'2015-03-02T20:58:49.656926Z', u'file_max_download': 3, u'can_delete_submission': False, u'show_small_cards': False, u'submission_timetolive': 48, u'postpone_superpower': True, u'tip_max_access': 500, u'steps': [{u'id': u'18e67a13-c3f5-459e-a546-5c3f53d432ba', u'label': u'Fill out your submission', u'children': [{u'fieldgroup_id': u'', u'description': u'', u'hint': u'Describe your submission with a few words', u'multi_entry': False, u'stats_enabled': False, u'required': False, u'children': [], u'value': u'', u'label': u'Short title', u'is_template': False, u'options': [], u'x': 0, u'y': 2, u'step_id': u'18e67a13-c3f5-459e-a546-5c3f53d432ba', u'preview': True, u'type': u'inputbox', u'id': u'058df7d1-c938-407b-af21-a496ebd6eb44'}, {u'fieldgroup_id': u'', u'description': u'', u'hint': u'Describe the details of the submission', u'multi_entry': False, u'stats_enabled': False, u'required': False, u'children': [], u'value': u'', u'label': u'Full description', u'is_template': False, u'options': [], u'x': 0, u'y': 3, u'step_id': u'18e67a13-c3f5-459e-a546-5c3f53d432ba', u'preview': False, u'type': u'textarea', u'id': u'40ec5609-33ac-46b3-b602-5d43276b157a'}, {u'fieldgroup_id': u'', u'description': u'', u'hint': u'Describe the attachments of the submission', u'multi_entry': False, u'stats_enabled': False, u'required': False, u'children': [], u'value': u'', u'label': u'Files description', u'is_template': False, u'options': [], u'x': 0, u'y': 4, u'step_id': u'18e67a13-c3f5-459e-a546-5c3f53d432ba', u'preview': False, u'type': u'textarea', u'id': u'6be1eb97-46f7-404e-910b-a1ce1108c295'}, {u'fieldgroup_id': u'', u'description': u'', u'hint': u'Attach files relevant to the submission', u'multi_entry': True, u'stats_enabled': False, u'required': False, u'children': [], u'value': u'', u'label': u'Files', u'is_template': False, u'options': [], u'x': 0, u'y': 5, u'step_id': u'18e67a13-c3f5-459e-a546-5c3f53d432ba', u'preview': False, u'type': u'fileupload', u'id': u'5c239590-c30a-46be-a2f0-a0c03d127078'}], u'description': u'', u'hint': u''}], u'last_update': u'2015-03-02T21:02:28.939257Z', u'id': u'3c3032f2-9b9c-4231-bbed-12e332188b07', u'name': u'claudio.agosti@logioshermes.org'}, 'tip_info': {u'context_id': u'3c3032f2-9b9c-4231-bbed-12e332188b07', u'expiration_date': u'2015-03-05T21:16:40.190467Z', u'access_counter': 0, u'creation_date': u'2015-03-02T21:16:49.935966Z', u'wb_steps': [{u'description': u'', u'hint': u'', u'children': [{u'fieldgroup_id': u'', u'description': u'', u'hint': u'Describe your submission with a few words', u'multi_entry': False, u'stats_enabled': False, u'required': False, u'value': u'', u'label': u'Short title', u'is_template': False, u'options': [], u'id': u'058df7d1-c938-407b-af21-a496ebd6eb44', u'step_id': u'18e67a13-c3f5-459e-a546-5c3f53d432ba', u'y': 2, u'x': 0, u'preview': True, u'type': u'inputbox', u'children': []}, {u'fieldgroup_id': u'', u'description': u'', u'hint': u'Describe the details of the submission', u'multi_entry': False, u'stats_enabled': False, u'required': False, u'value': u'', u'label': u'Full description', u'is_template': False, u'options': [], u'id': u'40ec5609-33ac-46b3-b602-5d43276b157a', u'step_id': u'18e67a13-c3f5-459e-a546-5c3f53d432ba', u'y': 3, u'x': 0, u'preview': False, u'type': u'textarea', u'children': []}, {u'fieldgroup_id': u'', u'description': u'', u'hint': u'Describe the attachments of the submission', u'multi_entry': False, u'stats_enabled': False, u'required': False, u'value': u'', u'label': u'Files description', u'is_template': False, u'options': [], u'id': u'6be1eb97-46f7-404e-910b-a1ce1108c295', u'step_id': u'18e67a13-c3f5-459e-a546-5c3f53d432ba', u'y': 4, u'x': 0, u'preview': False, u'type': u'textarea', u'children': []}, {u'fieldgroup_id': u'', u'description': u'', u'hint': u'Attach files relevant to the submission', u'multi_entry': True, u'stats_enabled': False, u'required': False, u'value': [], u'label': u'Files', u'is_template': False, u'options': [], u'id': u'5c239590-c30a-46be-a2f0-a0c03d127078', u'step_id': u'18e67a13-c3f5-459e-a546-5c3f53d432ba', u'y': 5, u'x': 0, u'preview': False, u'type': u'fileupload', u'children': []}], u'id': u'18e67a13-c3f5-459e-a546-5c3f53d432ba', u'label': u'Fill out your submission'}], u'last_access': u'2015-03-02T21:16:49.936172Z', u'id': u'654955c8-832f-4a91-9c1b-5f9b49f60b60'}, 'type': u'plaintext_upcoming_expire', 'storm_id': u'b0024350-fd87-4b72-b3c4-db6443ea6832'}


def dummyfunct(*a):
    print a

class TestMailNotifPlug(helpers.TestGLWithPopulatedDB):

    @inlineCallbacks
    def setUp(self):
        yield helpers.TestGLWithPopulatedDB.setUp(self)
        yield self.perform_submission()

    def test_sth(self):
        obD = OD(bigblob)

        x = MailNotification()
        x.do_notify(obD)

        x.mail_flush = dummyfunct
        print x

